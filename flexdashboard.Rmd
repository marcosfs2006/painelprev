---
title: "Painel da Gestão Previdenciária"
output:
  flexdashboard::flex_dashboard:
    navbar:
    - { title: "INFO", href: "http://rpubs.com/marcosfs2006/ADPrev", align: left }
    vertical_layout: scroll
    logo: figuras/rede-rpps2.png
runtime: shiny
---


```{r global, include=FALSE}
options(scipen = 99)
library(readxl)
library(readr)
library(dplyr)
library(lubridate)
library(knitr)
library(tidyr)
library(ggplot2)
library(flexdashboard)
library(DT)
library(stringr)
library(scales)

#-------------------------------------------------------------------------------
# Nota: Todo o pré-processamento dos dados que são aqui importados são feitos
# utilizando-se o script "etl_painel_previdenciario.R"
#-------------------------------------------------------------------------------

# Importa dados do DIPR 
#-------------------------------------------------------------------------------
dipr <- readRDS("dados/dipr.Rds")
dipr$ente  <- str_to_upper(dipr$ente)
dipr$ente2 <- str_to_upper(paste(dipr$ente, dipr$uf, sep=" - "))


# Importa dados dos parcelamentos
#-------------------------------------------------------------------------------
parcel <- readRDS("dados/parcelamentos.Rds")
parcel$ente <- str_to_upper(parcel$ente)


# Importa dados CRP
#-------------------------------------------------------------------------------
crp <- readRDS("dados/crp.Rds")

## Esse pré processamnto já pode ser feito antes...
crp <- crp %>%
         mutate(QtdDias = as.numeric(difftime(as.POSIXct(Sys.Date()), `DATA DE VALIDADE`, units = "days")))

crp <- crp %>%
        mutate(categoria = cut(QtdDias,
                               breaks =c(-Inf, 0, 30, 60, 90, 180, 365, 5*365, Inf) ,
                               labels = c("a vencer",
                                          "1 a 30 dias",
                                          "31 a 60 dias",
                                          "61 a 90 dias",
                                          "91 a 180 dias",
                                          "181 a 365 dias",
                                          "1 a 5 anos",
                                          "mais de 5 anos")))

# Importa dados do Indicador de Situação Previdenciária
#------------------------------------------------------
isp <- readRDS("dados/isp.Rds") # read_rds()
isp$ENTE <- gsub("^GOVERNO D[OEA] ", "", isp$ENTE)
isp$ENTE2 <- isp$ENTE
isp$ENTE <- gsub("(.*) - .*", "\\1", isp$ENTE)


# Importa dados do DAIR e arquivos relacionados
#----------------------------------------------
dair                <- readRDS("dados/dair.Rds")
fundos_vedados      <- readRDS("dados/fundos_vedados.Rds")
enquadramento_sprev <- readRDS("dados/enquadramento_sprev.Rds")
limites_cmn         <- readRDS("dados/limites_cmn.Rds")

# limpeza das bases
dair$ente <- str_to_upper(gsub("^Governo d[eoa] ", "", dair$ente))
#dair <- subset(dair, !is.na(tipo_ativo))
fundos_vedados$`CNPJ DO FUNDO` <- gsub("[[:punct:]]", "", fundos_vedados$`CNPJ DO FUNDO`)
limites_cmn$classificacao <- toupper(gsub('[[:punct:]]| |o', '', limites_cmn$ativo))




# Coisas para usar na UI
#-------------------------------------------------------------------------------

# Relação da Unidades da Federação
lista_uf <- sort(unique(isp$UF)) 

# Relação de todos os RPPS do Brasil.
#-------------------------------------
# Alterar esse cadastro... pegar entes da base do ISP
cadastro <- rbind(dipr[,  c("ente", "uf")],
                  parcel[,c("ente", "uf")]) %>%
            distinct() %>%
            mutate(ente = str_to_upper(ente),
                   ente =  gsub("^PREFEITURA MUNICIPAL D[EOA] ", "", ente)) %>%
            arrange(uf, ente)

# Usado no COMPREV (revisar isso...)
#------------------------------------
meses    <- as.Date(paste("01", unique(dipr$competencia), sep="/"), "%d/%B/%Y") 
meses2   <- factor(toupper(format(meses, "%b/%Y")), levels=toupper(format(meses, "%b/%Y")), ordered = TRUE)

# Nomes colunas DAIR
nmcol_meses_dair <- str_to_upper(format(unique(dair$competencia),"%b/%Y"))



## Código usado na COMPOSIÇÃO DA CARTEIRA
##-----------------------------------
dair_limites <- dair %>% 
                filter(competencia >= ymd("2018-04-01")) %>%
                mutate(classificacao = str_extract(tipo_ativo, "Art.*$"))

dair_limites <- dair_limites %>%
                mutate(classificacao =  ifelse(tipo_ativo == "Disp", "Disp",
                                        ifelse(tipo_ativo %in% c("Prédio Comercial", "Outros - Imóveis",
                                                                 "Terreno", "Casa", "Loja", "Prédio Residencial",
                                                                 "Apartamento"), "Imoveis",
                                        ifelse(tipo_ativo %in% c("Outros Bens, Direitos e Ativos",
                                                                 "Títulos de Renda Fixa",
                                                                 "Valores Mobiliários",
                                                                  "Fundos de Investimento não previstos em Resolução CMN"), "Outros",
                                                classificacao))))


dair_limites <- dair_limites %>%
  mutate(classificacao = ifelse(tipo_ativo == "FI 100% títulos TN", "Art. 7º, I, b",
                         ifelse(tipo_ativo == "FI de Renda Fixa", "Art. 7º, IV, b",
                         ifelse(tipo_ativo == "FI em Ações", "Art. 8º, II, a",
                         ifelse(tipo_ativo == "FI Multimercado - Aberto", "Art. 8º, III",
                         ifelse(tipo_ativo == "Fundo Investimento - Sufixo Investimento no Exterior", "Art. 9ºA, II", classificacao)))))
         )

dair_limites <- dair_limites %>%
  mutate(classificacao = toupper(gsub('[[:punct:]]| |º', '', classificacao)))

# Agrega os ativos
dair_limites_agreg <- dair_limites %>%
  group_by(cnpj, ente, uf, competencia, classificacao) %>%
  summarise(VlrTotalAtivo = sum(vlr_total_atual, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(cnpj, ente, uf, competencia) %>%
  mutate(pctVlrTotalAtivo = round(VlrTotalAtivo / sum(VlrTotalAtivo, na.rm=TRUE), 2))


## Código usado no  LIMITES RES. 3922/10
##------------------------------------
dair_limites_agreg_liq <- dair_limites %>%
  mutate(classificacao = ifelse(classificacao %in% c("ART7IIIA", "ART7IIIB"), "ART7III#",
                         ifelse(classificacao %in% c("ART7IVA", "ART7IVB"),   "ART7IV#", classificacao))) %>%
  group_by(cnpj, ente, uf, competencia, classificacao) %>%
  mutate(VlrTotalAtivoLiq = ifelse(classificacao %in% c("DISP", "IMOVEIS", "OUTROS"), 0, vlr_total_atual)) %>%
  summarise(VlrTotalAtivoLiq = sum(VlrTotalAtivoLiq, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(cnpj, ente, uf, competencia) %>%
  mutate(pctVlrTotalAtivoLiq = round(VlrTotalAtivoLiq / sum(VlrTotalAtivoLiq, na.rm=TRUE) * 100, 2)) %>%
  filter(!classificacao %in% c("DISP", "IMOVEIS", "OUTROS"))

dair_limites_agreg_liq <- dair_limites_agreg_liq %>%
                              left_join(limites_cmn[, c("classificacao", "limite", "limite_pl")],
                                        by="classificacao")

dair_limites_agreg_liq <- dair_limites_agreg_liq %>%
                              mutate(limite  = ifelse(classificacao == "ART7III#", 60,
                                               ifelse(classificacao == "ART7IV#",  40, limite)))





```

Sidebar {.sidebar}
===================================

```{r}
# Relação das UF
selectInput("UF", label = "Selecione a UF:", choices = lista_uf)

# Relação dos RPPS
uiOutput("municipios")

```

CRP {.tabset .tabset-fade}
==================================

crp {.tabset .tabset-fade}
------------------------------------

### **CRP VENCIDO E JUDICIAL POR UF**

<!--
a fazer: criar tabela para mostrar os entes com crp vencido e com crp judicial

-->

```{r}
# Preciso saber o nome do Ente...
output$municipios <- renderUI(
    selectInput(inputId = "municipios",
                  label = "Selecione o Ente:",
                  choices = as.list(cadastro$ente[cadastro$uf == input$UF]))
                )

```

<!--
Problemas a corrigir:
Incluir possibilidade de baixar os dados
-->

```{r}
# Quantidade de Entes com CRP Vencido e percentual
qtd_crp_uf <- crp %>%
                group_by(UF) %>%
                summarise(QtdRPPS = n(),
                          QtdRPPS_CRPVencido  = sum(`SITUAÇÃO DO CRP` == "VENCIDO"),
                          PctRPPS_CRPVencido  = round(QtdRPPS_CRPVencido / QtdRPPS * 100, 2),
                          QtdRPPS_CRPJudicial = sum(`CRP JUDICIAL` == "SIM"),
                          PctRPPS_CRPJudicial = round(QtdRPPS_CRPJudicial / QtdRPPS * 100, 2)) %>%
                arrange(desc(PctRPPS_CRPVencido)) 


# Elaboração da tabela de Entes com CRP Vencidos por UF
renderDataTable(datatable(qtd_crp_uf,
                          rownames=FALSE,
                          colnames =  c("QTD. RPPS", "QTD. CRP VENCIDO", "PCT CRP VENCIDO", "QTD. CRP JUDICIAL", "PCT. CRP JUDICIAL")))

```

### **GRÁFICO ESCALONAMENTO**

```{r}
crp_escalonamento_uf <- reactive({
  req(input$UF)
  crp %>%
    filter(UF == input$UF) %>%
    group_by(categoria) %>%
    summarise(frequencia = n()) 
})

renderPlot({
    ggplot(crp_escalonamento_uf(), aes(x=categoria, y=frequencia)) +
    geom_bar(stat="identity", fill="orange") +
    geom_text(aes(label=frequencia), color="blue", vjust = 0, hjust=1, size=4) +
    coord_flip() +
    ylab("Qtd. de Entes") +
    xlab(" ")
  
})
```



DAIR {.tabset .tabset-fade}
==================================

dair {.tabset .tabset-fade}
------------------------------------

<!--

A fazer: colocar em algum lugar um texto explicando cada tipo de ativo

-->



### **ENTREGA DAIR**

```{r}
# Entes na base do DAIR
entes_dair <- dair %>%
  select(ente, uf, competencia) %>%
  distinct() %>%
  unite(ente2, ente, uf, sep=" - ") %>%
  mutate(ente2 = iconv(ente2, from = "utf-8", to="ASCII//TRANSLIT"))

# Entes na base do ISP
entes_geral <- isp %>%
  select(ENTE2) %>%
  mutate(ENTE2 = iconv(ENTE2, from = "utf-8", to="ASCII//TRANSLIT"))

# Juntar as duas bases
entrega_dair <- entes_geral %>%
  left_join(entes_dair, by=c("ENTE2" = "ente2")) %>%
  mutate(entregou = "X") %>%
  distinct() %>%
  spread(key=competencia, value = entregou, fill = "-") %>%
  select(- `<NA>`)  


tab_entrega_dair <- reactive({

  req(input$UF)

  entrega_dair %>%
    filter(grepl(paste(input$UF, "$", sep=""), ENTE2))
})


renderDataTable(datatable(tab_entrega_dair(),
                          rownames = FALSE,
                          colnames = c("ENTE", format(as.Date(names(tab_entrega_dair())[-1]), "%m/%Y"))))


```


### **ATIVOS GARANTIDORES** 


```{r}
ativoGarantBruto <- dair %>%
  group_by(uf, ente, competencia) %>%
  summarize(vlrAtivoTotal = sum(vlr_total_atual, na.rm=TRUE)) 

## Gráfico Ativos Garantidores Brutos
#ativoGarantBruto %>%
#  filter(uf == UF, ente == ENTE) %>%
#  ggplot(aes(x=competencia, y=vlrAtivoTotal)) +
#  geom_line() +
#  geom_point() +
#  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
#  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m"))


##Liquido...
ativoGarantLiquido <- dair %>%
  filter(competencia >= ymd("2018-04-01"), grepl("Art.*$", tipo_ativo)) %>%
  group_by(uf, ente, competencia) %>%
  summarize(vlrAtivoTotal = sum(vlr_total_atual, na.rm=TRUE)) 

## Gráfico
#ativoGarantLiquido %>%
#  filter(uf == UF, ente == ENTE) %>%
#  ggplot(aes(x=competencia, y=vlrAtivoTotal)) +
#  geom_line() +
#  geom_point() +
#  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
#  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m"))


#### Junta as duas bases em uma só...
ativoGarantBruto$tipo   <- "Ativo Bruto"
ativoGarantLiquido$tipo <- "Ativo Liquido"
ativos_garantidores <- rbind(ativoGarantBruto,
                             ativoGarantLiquido)
rm(ativoGarantBruto, ativoGarantLiquido)


# Gráfico dos dois juntos...
tab_ativos_garantidores <- reactive({
  
  req(input$UF)
  req(input$municipios)
  
  ativos_garantidores %>%
    filter(uf == input$UF, ente == input$municipios)
})  
  
renderPlot({

ggplot(tab_ativos_garantidores(),aes(x=competencia, y=vlrAtivoTotal, group=tipo, color=tipo)) +
    geom_line(size=1) +
    geom_point(size=2) +
    theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
    scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m")) +
    theme_bw()
  
})  



```


### **FUNDOS VEDADOS**

```{r}
invest_fv <- dair %>%
               mutate(aplica_fundo_vedado = ifelse(ident_ativo %in% fundos_vedados$`CNPJ DO FUNDO`, 1, 0)) %>%
               filter(aplica_fundo_vedado == 1)

# Aplicação de filtro
tab_invest_fv <- reactive({
  req(input$UF)
  invest_fv %>%
  filter(uf == input$UF) %>%
  select(ente, ident_ativo, nm_ativo) %>%
  distinct() 
})

# Mostrar a tabela de dados.
renderDataTable(datatable(tab_invest_fv(), rownames = FALSE))

```



### **PERFIL INVEST.**

```{r}

tab_invest_ente <- reactive({

  req(input$UF)
  req(input$municipios)
  
  dair %>%
      filter(uf == input$UF, ente == input$municipios, competencia >= as.Date("2018-04-01")) %>%
      select(competencia, tipo_ativo, vlr_total_atual) %>%
      group_by(competencia, tipo_ativo) %>%
      summarise(vlr_total_atual = sum(vlr_total_atual, na.rm = TRUE)) %>%
      spread(key = competencia, value = vlr_total_atual) 
})


renderDataTable(datatable(tab_invest_ente(),
                          rownames = FALSE,
                          colnames = c("TIPO ATIVO", format(as.Date(names(tab_invest_ente())[-1]), "%m/%Y"))) %>%
                formatCurrency(columns = -1,
                               currency = "",
                               interval = 3,
                               mark = ".",
                               digits = 2,
                               dec.mark = ",",
                               before = TRUE) 
                )

```



### **VISUALIZAÇÃO PERFIL**

<!-- separar renda fixa e renda variável -->

```{r}
tab_perfil <- reactive({
  
  req(input$UF)
  req(input$municipios)
  
  dair %>%
    filter(uf == input$UF, ente == input$municipios, grepl("\\d{14}", ident_ativo)) %>%
    mutate(fundos = paste(nm_ativo, " [", ident_ativo, "]", sep = "")) %>%
    group_by(competencia, fundos) %>%
    summarise(vlr_total_atual = sum(vlr_total_atual, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(competencia) %>%
    mutate(pct_aplic_fundo = vlr_total_atual / sum(vlr_total_atual, na.rm = TRUE),
           vedado = ifelse(gsub(".*\\[(.*)\\]", "\\1", fundos) %in% fundos_vedados$`CNPJ DO FUNDO`, "Vedado", "Permitido")) 

})

#medias <- perfil %>%
#  group_by(fundos) %>%
#  summarise(media = mean(pct_aplic_fundo, na.rm = TRUE)) %>%
#  arrange(desc(media)) %>%
#  mutate(ordem = rank(media, ties.method= "first"))  

# Elaborar o gráfico
renderPlot({
  ggplot(tab_perfil(), aes(x=competencia, y=fundos, size=pct_aplic_fundo, colour=factor(vedado))) +
    geom_point() +
    xlab("Meses") + ylab("Fundos") +
    scale_color_manual(values = c("lightblue", "tomato")) +
    theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
    scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m")) +
    theme_bw()
})


```



### **ENQUAD. FI**

```{r}
# Aumentou a quantidade de registros quando fez o join... Investigar...
invest_fundos <- dair %>%
                  filter(competencia >= as.Date("2018-04-01"), grepl("\\d{14}", ident_ativo)) %>%
                  mutate(enquad_rpps = str_extract(tipo_ativo, "Art.*$")) %>%
                  left_join(enquadramento_sprev[,c("cnpj", "nm_fundo", "enquad_sprev")],
                            by=c("ident_ativo" = "cnpj")) %>%
                  mutate(enquad_rpps = toupper(gsub('[[:punct:]]| |º', '', enquad_rpps)),
                         enquad_sprev= toupper(gsub('[[:punct:]]| |º', '', enquad_sprev)))

invest_fundos$diverg_enquad <- ifelse(invest_fundos$enquad_rpps == invest_fundos$enquad_sprev, 0, 1)
divergencia_enquad <- invest_fundos %>% filter(diverg_enquad == 1)


tab_diverg_enquad_rpps <- reactive({
  
  req(input$UF)
  req(input$municipios)

divergencia_enquad %>%
        filter(uf == input$UF, ente == input$municipios) %>%
        select(ente, competencia, ident_ativo, nm_ativo, enquad_rpps, enquad_sprev) %>%
        arrange(competencia)  

})

# Tabela com os valores.
renderDataTable(datatable(tab_diverg_enquad_rpps(), rownames = FALSE))

```


### **COMPOSIÇÃO DA CARTEIRA**

```{r}

tab_limites_agreg <- reactive({
  
  req(input$UF)
  req(input$municipios)

  dair_limites_agreg %>%
  filter(uf == input$UF, ente == input$municipios) 
    
})    


renderPlot({
  ggplot(tab_limites_agreg(),aes(x=competencia, y=pctVlrTotalAtivo, group=classificacao, color=classificacao)) +
  geom_line(size=1.5) +
  geom_point(size=4) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m")) +
  theme_bw()

})

```



### **LIMITES RES. 3922/10**

```{r}
tab_limites_res_cmn <- reactive({
  req(input$UF)
  req(input$municipios)
  dair_limites_agreg_liq %>%
    filter(uf == input$UF, ente == input$municipios)
})  
  
renderPlot({
  ggplot(tab_limites_res_cmn(),aes(x=competencia, y=pctVlrTotalAtivoLiq)) +
    geom_point() +
    facet_wrap( ~ classificacao) +
    geom_hline(aes(yintercept = limite), color="blue") +
    labs(title = "Evolucao do Percentual Aplicado por Tipo de Ativo",
         y = '% Aplicado', x=" ") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
    scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m"))
})

```




DIPR {.tabset .tabset-fade}
===================================

dipr {.tabset .tabset-fade}
------------------------------------

<!--
Dar uma mensagem caso seja selecionado um Ente que não tenha encaminhado nenhum DIPR
-->

### **ENTREGA DIPR**

>O **X** indica a entrega do DIPR no mês correspondente.

<!--

AC está com problemas... ver o que é.

-->

```{r}
entrega_dipr <- reactive({ 
  req(input$UF)
  isp %>%
    select(ENTE2) %>%
    left_join(dipr[, c("ente2", "competencia")], by=c("ENTE2" = "ente2")) %>%
    mutate(entregou = "X",
          competencia = factor(competencia, levels = unique(dipr$competencia), ordered = TRUE)) %>%
    filter(grepl(paste(input$UF, "$", sep=""), ENTE2)) %>%
    distinct() %>%
    spread(key=competencia, value = entregou, fill = "-") %>%
    select(- `<NA>`)  
})

# Exibe a tabela
renderDataTable(datatable(entrega_dipr(),
                          rownames = FALSE))

```



### **RECEITAS E DESPESAS**


```{r}
dipr_recdesp <- reactive({
  
  req(input$UF)
  req(input$municipios)

  dipr %>%
    filter(uf == input$UF, ente == input$municipios) %>%
    select(ente, competencia, plano_segreg, total_receita, total_despesa) %>%
    mutate(competencia = as.Date(paste("01", competencia, sep = "/"), "%d/%B/%Y")) %>%
    gather(total_receita, total_despesa, key="tipo" , value="valores")

})


renderPlot({
  ggplot(dipr_recdesp(),
         aes(x=competencia, y=valores, group=tipo, color=tipo)) +
  geom_line(size=1) +
  geom_point(size=3) +
  xlab("Meses") +
  ylab("Valores") +
  scale_color_discrete(name = "Categoria", labels = c("Despesa Total", "Receita Total")) + 
  facet_wrap(~ plano_segreg) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m")) +
  theme_bw()
})


```

### **CONTRIBUIÇÕES** 

<!--

todo: se for apenas um gráfico, reduzir o tamanho.
     se for selecionado um ente (por exemplo Campos dos Goytacazes) que não consta da
     base de DIPR, colocar uma mensagem no dashboard

-->

```{r}

teste <- function(x){!all(is.na(x))}

dipr_contribuicoes <- reactive({

  req(input$municipios)
  req(input$UF)
  
  dipr %>%
    filter(ente == input$municipios, uf == input$UF) %>%
    select(competencia, plano_segreg, ct_pat_serv, ct_pat_serv_ug, ct_pat_apo, ct_pat_pen, ct_serv, ct_apo, ct_pen) %>%
    select_if(teste) %>% 
    gather(key=tipo, value=contribuicao, -competencia, -plano_segreg) %>%
    mutate(competencia = as.Date(paste("01", competencia, sep = "/"), "%d/%B/%Y"))
})


# Gráfico dos dados acima.
renderPlot(dipr_contribuicoes() %>%
  ggplot(aes(x=competencia, y=contribuicao, group = tipo, color = tipo)) +
  geom_line(size=1) +
  geom_point(size=3) +
  xlab("Meses") +
  ylab("Valor Contribuição") +
  scale_color_discrete(name = "Contribuição") +
  facet_wrap(~plano_segreg) + 
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m")) +
  theme_bw()
)

```




### **SEGREGAÇÃO DE MASSAS**

```{r}
segregacao_massas <- reactive({
                     dipr %>%
                        filter(uf == input$UF) %>%
                        select(ente, plano_segreg) %>%
                        distinct() %>%
                        mutate(plano = "X") %>%
                        spread(key=plano_segreg, value=plano, fill = "-") 
                      })

renderDataTable({
  datatable(segregacao_massas(),
            rownames = FALSE,
            extensions = 'Buttons',
            options = list(columnDefs = list(list(className = 'dt-center', targets = 1:2)),
                           dom = 'Blfrtip', # inclui o "l"
                           buttons = 'excel')
           )
})

```


### **COMPREV**

```{r}
comprev <- reactive({
  req(input$UF)
  dipr %>%
    filter(uf == input$UF) %>%
    select(ente, competencia, ing_comprev) %>% 
    mutate(competencia = factor(competencia, levels=meses2, ordered = TRUE)) %>%
    group_by(ente, competencia) %>%
    summarise(comprev = sum(ing_comprev, na.rm=TRUE)) %>%
    spread(key=competencia, value=comprev)
})
  

renderDataTable(datatable(comprev(),
                          rownames = FALSE,
                          extensions = 'Buttons',
                          options = list(dom = 'Blfrtip',
                                         buttons = 'excel')) %>%
                formatCurrency(columns = -1,
                               currency = "",
                               interval = 3,
                               mark = ".",
                               digits = 2,
                               dec.mark = ",",
                               before = TRUE)  
                )

```



### **QTD. SERVIDORES ATIVOS** 

<!--
incluir inativos pensionistas
> Gráfico da evolução do quantitativo de servidores ativos.
-->

```{r}
dipr_qtdbenef <- reactive({
  
  req(input$UF)
  req(input$municipios)

  dipr %>%
    filter(uf == input$UF, ente == input$municipios) %>%
    select(competencia, plano_segreg, nb_serv, nb_apos, nb_pen, nb_dep) %>%
    mutate(competencia = as.Date(paste("01", competencia, sep = "/"), "%d/%B/%Y"))
})
  
renderPlot({  
    ggplot(dipr_qtdbenef() ,aes(x=competencia, y=nb_serv, group=1)) +
    geom_line() +
    geom_point() +
    facet_wrap(~ plano_segreg) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
    scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m"))

})

```


### **RECEBIMENTO PARCELAMENTOS** {data-width=600}

<!--
> Gráficos ilustrando o recebimento de receitas de parcelamentos
-->

```{r}

dipr_receita_parcelamentos <- reactive({
  
  req(input$UF)
  req(input$municipios)
  
  dipr %>%
    filter(uf == input$UF, ente == input$municipios, !is.na(parcelamentos) | !is.na(ing_parc)) %>%
    select(ente, competencia, plano_segreg, parcelamentos, ing_parc) %>%
    mutate(competencia = as.Date(paste("01", competencia, sep = "/"), "%d/%B/%Y")) 
})

  
renderPlot({  

  ggplot(dipr_receita_parcelamentos(), aes(x=competencia, y=parcelamentos)) +
  geom_line() +
  geom_point(size=2) +
  facet_wrap(~ plano_segreg) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5)) +
  scale_x_date(date_breaks="1 month", labels = date_format("%Y-%m"))

})

```



PARCELAMENTOS {.tabset .tabset-fade}
==========================================

parcelamentos {.tabset .tabset-fade}
------------------------------------


### **CONSOLIDADO**

> Consolidação dos parcelamentos dos Entes da UF selecionada vigentes em 31.12.18: </br> (*Exclui parcelamentos não aceitos e repactuados*)

```{r}
# Agregação dos parcelamentos
tab_parcel_ativos <- reactive({
                        
    req(input$UF)
                      
    parcel %>%
      filter(uf == input$UF, !situacao %in% c("Não aceito", "Repactuado")) %>%  
      mutate(dt_fim = as.Date(dt_assin, format="%d/%m/%Y")  %m+% months(as.integer(qtd_parc))) %>%
      filter(ymd("2018-12-31") %within% interval(dmy(dt_assin), dt_fim)) %>% 
      group_by(ente) %>%
      summarise(qtd_acordos = n(),
                valor_consolidado = sum(vlr_consolid, na.rm=TRUE),
                sd_sem_atualiz = sum(sd_estim_satualiz, na.rm = TRUE),
                percentual = round(sd_sem_atualiz / valor_consolidado * 100, 2)) %>%
      arrange(desc(valor_consolidado))
})



renderDataTable(datatable(tab_parcel_ativos(),
                          rownames = FALSE,
                          colnames = c("Ente", "Qtd. Acordos", "Vlr. Consol.", "Sd. sem Atualiz.", "Percentual")) %>%
                formatCurrency(columns=c(3, 4, 5),
                               currency = "",
                               interval = 3,
                               mark = ".",
                               digits = 2,
                               dec.mark = ",",
                               before = TRUE)
                )

```



### **REL. ACORDOS ENTE**

> Relação dos parcelamentos ativos em **31.12.18** do Ente selecionado. </br> (*Exclui parcelamentos não aceitos*)

```{r}
# todo: colocar um widget para receber a data de reverência
#       deixar na relação tudo. 
# dt_ref <- "2018-12-31"

# Filtro dos parcelamentos
parcel_ativos <- reactive({
  req(input$UF)
  req(input$municipios)
  parcel %>%
  filter(uf == input$UF, ente == input$municipios, situacao != "Não aceito") %>%   
  select(ente, situacao, num_acordo, dt_assin, qtd_parc, dt_venc_1a, vlr_consolid, sd_estim_satualiz) %>%
  mutate(dt_fim = as.Date(dt_assin, format="%d/%m/%Y")  %m+% months(as.integer(qtd_parc))) %>%
  filter(ymd("2018-12-31") %within% interval(dmy(dt_assin), dt_fim)) # ativos em 31/12/2018 
})

renderDataTable(datatable(parcel_ativos(),
                colnames=c("Ente", "Situação", "Num. Acordo", "Dt. Assin.", "Qtd. Parcelas", "Dt. Venc. 1a Parc.", "Vlr. Consolidado", "Sd. Estimado sem Atualiz.", "Dt. Fim"),
                rownames = FALSE) %>%
                formatCurrency(columns=c(7, 8),
                               currency = "",
                               interval = 3,
                               mark = ".",
                               digits = 2,
                               dec.mark = ",",
                               before = TRUE)  
                )

```





DRAA {.tabset .tabset-fade}
===================================

draa {.tabset .tabset-fade}
------------------------------------

<center>

![](figuras/men-at-work2.gif)

</center>


ISP
===================================

isp 
-----------------------------------

<!--
TODO:
Colocar um gráfico do isp do rpps em relação ao brasil
Colocar um gráfico do isp do rpps em relação ao seu grupo no brasil
      
Os municipios de NOVA ITARANA - BA e
BONITO-BA não estão aparecendo no gráfico do ISP. Verificar.

Quando a UF tiver poucos rpps (< 5), não mostrar o boxplot,
mostrar apenas os pontos.

-->

Indicador do RPPS em comparação com o indicador dos demais RPPS do Estado.


```{r, fig.align='center'}
isp_rpps <- reactive({
  req(input$UF)
  isp %>%
     filter(UF == input$UF) 
})

renderPlot({

  req(input$UF)
  req(input$municipios)
  
     ggplot(isp_rpps(), aes(x=as.factor(UF), y=ISP201801)) +
     geom_boxplot() +
     labs(x="", y = "ISP") +
     geom_dotplot(binaxis = "y", stackdir="center", fill="lightgray", color="lightgray") +
     geom_point(y=isp$ISP201801[isp$ENTE == input$municipios], color="red", size=6, shape=20) +
     theme_bw()
  
}, width =250)  
```

